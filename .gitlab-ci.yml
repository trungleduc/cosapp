stages:
  - test
  - test_docs
  - test_build
  - deploy

variables:
  COSAPP_DEP: jsonschema numpy<2 scipy pandas wrapt pytest<8.1 jinja2 pyfmi pythonfmu<0.6.3
  USER: "cosapp_test"

.job_rules:
  rules:
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
    - when: manual

# Test script for all OS
.test_script:
  script:  
    - micromamba create -y -n cosapp python=$PYTHON_VERSION
    - micromamba activate cosapp
    - micromamba install -y $COSAPP_DEP
    - pip install . --trusted-host=files.pythonhosted.org
    - python -m pytest

# # default windows job parameters
# .windows_env:
#   stage: "test"
#   tags:
#     - shared-windows
#     - windows
#     - windows-1809
#   before_script:
#     - Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"
#     - choco install -y miniconda3 --params="'/AddToPath:1'"
#     - RefreshEnv
#     - conda config --add channels conda-forge
#     - conda init powershell
#     - "if (test-path $PROFILE.CurrentUserAllHosts) { & $PROFILE.CurrentUserAllHosts}"
#     - md -Path $env:USERPROFILE\.cosapp.d

# default linux environment parameters
.linux_common_env:
  image: "mambaorg/micromamba:latest"
  before_script:
    - eval "$(micromamba shell hook --shell bash)"
    - micromamba activate
    - micromamba shell init --shell bash --root-prefix=~/micromamba
    - micromamba config append channels conda-forge
    - mkdir -p $HOME/.cosapp.d

# default linux job parameters
.linux_env:
  extends: 
    - ".linux_common_env"
  tags: 
    - cosapp_runner
  stage: test

# Deployment env (runs on public runner)
.deploy_env:
  extends: 
    - ".linux_common_env"
  stage: deploy

linux_py39:
    extends: 
     - ".linux_env"
     - ".job_rules"
     - ".test_script"
    variables:
      PYTHON_VERSION: "3.9"

linux_py310:
    extends: 
     - ".linux_env"
     - ".job_rules"
     - ".test_script"
    variables:
      PYTHON_VERSION: "3.10"

linux_py311:
  extends: 
    - ".linux_env"
    - ".job_rules"
  variables:
    PYTHON_VERSION: "3.11"
  script:
    - micromamba create -y -n cosapp python=$PYTHON_VERSION
    - micromamba activate cosapp
    - micromamba install -y $COSAPP_DEP coverage
    - pip install .
    - coverage erase
    - coverage run -m pytest -ra
    - coverage report
    - coverage html -d coverage/    
  artifacts:
    paths:
      - coverage/  
    expire_in: 2 weeks  


# windows_py311:
#     extends: 
#      - ".windows_env"
#      - ".test_script"
#     variables:
#       PYTHON_VERSION: "3.11"


# Deployment jobs
build_doc:
  stage: test_docs
  needs: []
  extends: 
    - ".linux_env"
    - ".job_rules"
  variables:
    BUILDDIR: _build
    PYTHON_VERSION : "3.11"
  script:
    - micromamba env create --name cosapp --file docs/environment.yml
    - micromamba activate cosapp
    - pip install .
    # Build the documentation
    - cd docs/
    - sphinx-build -b html -d $BUILDDIR/doctrees . $BUILDDIR
    
  artifacts:
    paths:
      - docs/$BUILDDIR


build_pkg:
  stage: test_build
  needs: []
  extends: 
    - ".linux_common_env"
    - ".job_rules"
  variables:
    JOB_DEP: conda-build conda-verify pip setuptools jupyterlite-core jupyterlite-xeus ipywidgets jupyter_server
    PYTHON_VERSION : "3.11"
  script:
    - micromamba create -y -n cosapp python=$PYTHON_VERSION
    - micromamba activate cosapp
    - micromamba install -y $JOB_DEP
    - python setup.py sdist bdist_wheel
    - conda build -c conda-forge --no-test --output-folder ./dist conda.recipe
    - cd jupyterlite
    - python build.py
  artifacts:
    paths:
      - dist/


deploy:
  extends: 
    - ".deploy_env"
  variables:
    JOB_DEP: setuptools wheel twine packaging anaconda-client conda-build conda-verify
    TWINE_USERNAME: __token__
    TWINE_PASSWORD: $PYPI
    CONDA_USERNAME: cosapp
    CONDA_UPLOAD_TOKEN : $CONDA_UPLOAD_TOKEN
  script:
    - micromamba install -y $JOB_DEP
    - python setup.py sdist bdist_wheel
    - twine upload dist/*.tar.gz
    - twine upload dist/*.whl
    - conda build -c conda-forge --no-test --output-folder ./dist conda.recipe
    - anaconda -t $CONDA_UPLOAD_TOKEN upload -u $CONDA_USERNAME ./dist/noarch/cosapp*

  artifacts:
    paths:
      - dist/
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success


pages:
  extends: 
  - ".deploy_env"
  tags: 
    - cosapp_runner
  stage: deploy
  variables:
    PYTHON_VERSION: "3.12" 
  script:
    - micromamba install -y pip setuptools jupyterlite-core jupyterlite-xeus ipywidgets jupyter_server
    - python setup.py sdist
    - cd jupyterlite
    - python build.py
    - mv dist/ ../public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
